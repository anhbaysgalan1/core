'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _electron = require('electron');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
* Settings object.
* @typedef {Object} PluginSettings
* @property {boolean} fileName - the name of the json file
*/

/**
 * Implements a simple localstorage replacement for Meteor Desktop.
 *
 * @class
 */
class LocalStorage {

    /**
     * @param {Object} log              - Winston logger
     * @param {Object} eventsBus        - event emitter for listening or emitting events on the
     *                                    desktop side
     * @param {PluginSettings} settings - plugin settings
     * @param {Object} Module           - reference to Module class
     */
    constructor({
        log,
        eventsBus,
        settings,
        Module
    }) {
        const storageModule = new Module('localStorage');

        const { fileName = 'localstorage.json' } = settings;

        this.storageFile = _path2.default.join(_electron.app.getPath('userData'), fileName);
        this.storage = {};
        this.initDone = false;
        this.eventsBus = eventsBus;
        this.log = log;

        eventsBus.on('desktopLoaded', () => {
            this.init();
        });

        storageModule.on('set', (event, key, value) => {
            this.storage[key] = value;
            if (this.initDone) {
                this.flush();
            }
        });

        storageModule.on('clear', () => {
            this.storage = {};
            if (this.initDone) {
                this.flush();
            }
        });

        storageModule.on('remove', (event, key) => {
            delete this.storage[key];
            if (this.initDone) {
                this.flush();
            }
        });

        storageModule.on('getAll', (event, fetchId) => {
            this.log.verbose('getAll received');
            if (this.initDone) {
                this.log.verbose('sent storage to renderer');
                storageModule.respond('getAll', fetchId, this.storage);
            }
        });
    }

    /**
     * Flushes the current storage to file.
     */
    flush() {
        _fs2.default.writeFile(this.storageFile, JSON.stringify(this.storage), 'utf8');
    }

    /**
     * Loads the storage json file. If there were any keys already set it merges them
     * with what has been loaded.
     */
    init() {
        let storage = {};
        _fs2.default.readFile(this.storageFile, 'utf8', (err, data) => {
            if (err) {
                this.flush();
            } else {
                try {
                    storage = JSON.parse(data);
                    this.log.info(`loaded storage file ${ this.storageFile }`);
                } catch (e) {
                    this.log.warn(`could not parse the storage file ${ this.storageFile }`);
                    // Nothing to do here. We will put a fresh file in place few lines below.
                }
                if (Object.keys(this.storage).length > 0) {
                    this.storage = Object.assign(storage, this.storage);
                } else {
                    this.storage = storage;
                }
                this.flush();
            }
            this.initDone = true;
            this.log.info(`have ${ Object.keys(this.storage).length } keys`);
            this.eventsBus.emit('localStorage.loaded');
        });
    }
}
exports.default = LocalStorage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJMb2NhbFN0b3JhZ2UiLCJjb25zdHJ1Y3RvciIsImxvZyIsImV2ZW50c0J1cyIsInNldHRpbmdzIiwiTW9kdWxlIiwic3RvcmFnZU1vZHVsZSIsImZpbGVOYW1lIiwic3RvcmFnZUZpbGUiLCJqb2luIiwiZ2V0UGF0aCIsInN0b3JhZ2UiLCJpbml0RG9uZSIsIm9uIiwiaW5pdCIsImV2ZW50Iiwia2V5IiwidmFsdWUiLCJmbHVzaCIsImZldGNoSWQiLCJ2ZXJib3NlIiwicmVzcG9uZCIsIndyaXRlRmlsZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZWFkRmlsZSIsImVyciIsImRhdGEiLCJwYXJzZSIsImluZm8iLCJlIiwid2FybiIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJhc3NpZ24iLCJlbWl0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQzs7Ozs7O0FBTUQ7Ozs7O0FBS2UsTUFBTUEsWUFBTixDQUFtQjs7QUFFOUI7Ozs7Ozs7QUFPQUMsZ0JBQVk7QUFDUkMsV0FEUTtBQUVSQyxpQkFGUTtBQUdSQyxnQkFIUTtBQUlSQztBQUpRLEtBQVosRUFLRztBQUNDLGNBQU1DLGdCQUFnQixJQUFJRCxNQUFKLENBQVcsY0FBWCxDQUF0Qjs7QUFFQSxjQUFNLEVBQUVFLFdBQVcsbUJBQWIsS0FBcUNILFFBQTNDOztBQUVBLGFBQUtJLFdBQUwsR0FBbUIsZUFBS0MsSUFBTCxDQUFVLGNBQUlDLE9BQUosQ0FBWSxVQUFaLENBQVYsRUFBbUNILFFBQW5DLENBQW5CO0FBQ0EsYUFBS0ksT0FBTCxHQUFlLEVBQWY7QUFDQSxhQUFLQyxRQUFMLEdBQWdCLEtBQWhCO0FBQ0EsYUFBS1QsU0FBTCxHQUFpQkEsU0FBakI7QUFDQSxhQUFLRCxHQUFMLEdBQVdBLEdBQVg7O0FBRUFDLGtCQUFVVSxFQUFWLENBQWEsZUFBYixFQUE4QixNQUFNO0FBQ2hDLGlCQUFLQyxJQUFMO0FBQ0gsU0FGRDs7QUFJQVIsc0JBQWNPLEVBQWQsQ0FBaUIsS0FBakIsRUFBd0IsQ0FBQ0UsS0FBRCxFQUFRQyxHQUFSLEVBQWFDLEtBQWIsS0FBdUI7QUFDM0MsaUJBQUtOLE9BQUwsQ0FBYUssR0FBYixJQUFvQkMsS0FBcEI7QUFDQSxnQkFBSSxLQUFLTCxRQUFULEVBQW1CO0FBQ2YscUJBQUtNLEtBQUw7QUFDSDtBQUNKLFNBTEQ7O0FBT0FaLHNCQUFjTyxFQUFkLENBQWlCLE9BQWpCLEVBQTBCLE1BQU07QUFDNUIsaUJBQUtGLE9BQUwsR0FBZSxFQUFmO0FBQ0EsZ0JBQUksS0FBS0MsUUFBVCxFQUFtQjtBQUNmLHFCQUFLTSxLQUFMO0FBQ0g7QUFDSixTQUxEOztBQU9BWixzQkFBY08sRUFBZCxDQUFpQixRQUFqQixFQUEyQixDQUFDRSxLQUFELEVBQVFDLEdBQVIsS0FBZ0I7QUFDdkMsbUJBQU8sS0FBS0wsT0FBTCxDQUFhSyxHQUFiLENBQVA7QUFDQSxnQkFBSSxLQUFLSixRQUFULEVBQW1CO0FBQ2YscUJBQUtNLEtBQUw7QUFDSDtBQUNKLFNBTEQ7O0FBT0FaLHNCQUFjTyxFQUFkLENBQWlCLFFBQWpCLEVBQTJCLENBQUNFLEtBQUQsRUFBUUksT0FBUixLQUFvQjtBQUMzQyxpQkFBS2pCLEdBQUwsQ0FBU2tCLE9BQVQsQ0FBaUIsaUJBQWpCO0FBQ0EsZ0JBQUksS0FBS1IsUUFBVCxFQUFtQjtBQUNmLHFCQUFLVixHQUFMLENBQVNrQixPQUFULENBQWlCLDBCQUFqQjtBQUNBZCw4QkFBY2UsT0FBZCxDQUFzQixRQUF0QixFQUFnQ0YsT0FBaEMsRUFBeUMsS0FBS1IsT0FBOUM7QUFDSDtBQUNKLFNBTkQ7QUFPSDs7QUFFRDs7O0FBR0FPLFlBQVE7QUFDSixxQkFBR0ksU0FBSCxDQUFhLEtBQUtkLFdBQWxCLEVBQStCZSxLQUFLQyxTQUFMLENBQWUsS0FBS2IsT0FBcEIsQ0FBL0IsRUFBNkQsTUFBN0Q7QUFDSDs7QUFFRDs7OztBQUlBRyxXQUFPO0FBQ0gsWUFBSUgsVUFBVSxFQUFkO0FBQ0EscUJBQUdjLFFBQUgsQ0FBWSxLQUFLakIsV0FBakIsRUFBOEIsTUFBOUIsRUFBc0MsQ0FBQ2tCLEdBQUQsRUFBTUMsSUFBTixLQUFlO0FBQ2pELGdCQUFJRCxHQUFKLEVBQVM7QUFDTCxxQkFBS1IsS0FBTDtBQUNILGFBRkQsTUFFTztBQUNILG9CQUFJO0FBQ0FQLDhCQUFVWSxLQUFLSyxLQUFMLENBQVdELElBQVgsQ0FBVjtBQUNBLHlCQUFLekIsR0FBTCxDQUFTMkIsSUFBVCxDQUFlLHdCQUFzQixLQUFLckIsV0FBWSxHQUF0RDtBQUNILGlCQUhELENBR0UsT0FBT3NCLENBQVAsRUFBVTtBQUNSLHlCQUFLNUIsR0FBTCxDQUFTNkIsSUFBVCxDQUFlLHFDQUFtQyxLQUFLdkIsV0FBWSxHQUFuRTtBQUNBO0FBQ0g7QUFDRCxvQkFBSXdCLE9BQU9DLElBQVAsQ0FBWSxLQUFLdEIsT0FBakIsRUFBMEJ1QixNQUExQixHQUFtQyxDQUF2QyxFQUEwQztBQUN0Qyx5QkFBS3ZCLE9BQUwsR0FBZXFCLE9BQU9HLE1BQVAsQ0FBY3hCLE9BQWQsRUFBdUIsS0FBS0EsT0FBNUIsQ0FBZjtBQUNILGlCQUZELE1BRU87QUFDSCx5QkFBS0EsT0FBTCxHQUFlQSxPQUFmO0FBQ0g7QUFDRCxxQkFBS08sS0FBTDtBQUNIO0FBQ0QsaUJBQUtOLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxpQkFBS1YsR0FBTCxDQUFTMkIsSUFBVCxDQUFlLFNBQU9HLE9BQU9DLElBQVAsQ0FBWSxLQUFLdEIsT0FBakIsRUFBMEJ1QixNQUFPLFFBQXZEO0FBQ0EsaUJBQUsvQixTQUFMLENBQWVpQyxJQUFmLENBQW9CLHFCQUFwQjtBQUNILFNBckJEO0FBc0JIO0FBOUY2QjtrQkFBYnBDLFkiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhcHAgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbiAvKipcbiAqIFNldHRpbmdzIG9iamVjdC5cbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBsdWdpblNldHRpbmdzXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpbGVOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGpzb24gZmlsZVxuICovXG5cbi8qKlxuICogSW1wbGVtZW50cyBhIHNpbXBsZSBsb2NhbHN0b3JhZ2UgcmVwbGFjZW1lbnQgZm9yIE1ldGVvciBEZXNrdG9wLlxuICpcbiAqIEBjbGFzc1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMb2NhbFN0b3JhZ2Uge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IGxvZyAgICAgICAgICAgICAgLSBXaW5zdG9uIGxvZ2dlclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudHNCdXMgICAgICAgIC0gZXZlbnQgZW1pdHRlciBmb3IgbGlzdGVuaW5nIG9yIGVtaXR0aW5nIGV2ZW50cyBvbiB0aGVcbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2t0b3Agc2lkZVxuICAgICAqIEBwYXJhbSB7UGx1Z2luU2V0dGluZ3N9IHNldHRpbmdzIC0gcGx1Z2luIHNldHRpbmdzXG4gICAgICogQHBhcmFtIHtPYmplY3R9IE1vZHVsZSAgICAgICAgICAgLSByZWZlcmVuY2UgdG8gTW9kdWxlIGNsYXNzXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioe1xuICAgICAgICBsb2csXG4gICAgICAgIGV2ZW50c0J1cyxcbiAgICAgICAgc2V0dGluZ3MsXG4gICAgICAgIE1vZHVsZVxuICAgIH0pIHtcbiAgICAgICAgY29uc3Qgc3RvcmFnZU1vZHVsZSA9IG5ldyBNb2R1bGUoJ2xvY2FsU3RvcmFnZScpO1xuXG4gICAgICAgIGNvbnN0IHsgZmlsZU5hbWUgPSAnbG9jYWxzdG9yYWdlLmpzb24nIH0gPSBzZXR0aW5ncztcblxuICAgICAgICB0aGlzLnN0b3JhZ2VGaWxlID0gcGF0aC5qb2luKGFwcC5nZXRQYXRoKCd1c2VyRGF0YScpLCBmaWxlTmFtZSk7XG4gICAgICAgIHRoaXMuc3RvcmFnZSA9IHt9O1xuICAgICAgICB0aGlzLmluaXREb25lID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZXZlbnRzQnVzID0gZXZlbnRzQnVzO1xuICAgICAgICB0aGlzLmxvZyA9IGxvZztcblxuICAgICAgICBldmVudHNCdXMub24oJ2Rlc2t0b3BMb2FkZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmluaXQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc3RvcmFnZU1vZHVsZS5vbignc2V0JywgKGV2ZW50LCBrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0b3JhZ2Vba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdERvbmUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHN0b3JhZ2VNb2R1bGUub24oJ2NsZWFyJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdG9yYWdlID0ge307XG4gICAgICAgICAgICBpZiAodGhpcy5pbml0RG9uZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmx1c2goKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgc3RvcmFnZU1vZHVsZS5vbigncmVtb3ZlJywgKGV2ZW50LCBrZXkpID0+IHtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2Vba2V5XTtcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXREb25lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mbHVzaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzdG9yYWdlTW9kdWxlLm9uKCdnZXRBbGwnLCAoZXZlbnQsIGZldGNoSWQpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nLnZlcmJvc2UoJ2dldEFsbCByZWNlaXZlZCcpO1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdERvbmUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy52ZXJib3NlKCdzZW50IHN0b3JhZ2UgdG8gcmVuZGVyZXInKTtcbiAgICAgICAgICAgICAgICBzdG9yYWdlTW9kdWxlLnJlc3BvbmQoJ2dldEFsbCcsIGZldGNoSWQsIHRoaXMuc3RvcmFnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZsdXNoZXMgdGhlIGN1cnJlbnQgc3RvcmFnZSB0byBmaWxlLlxuICAgICAqL1xuICAgIGZsdXNoKCkge1xuICAgICAgICBmcy53cml0ZUZpbGUodGhpcy5zdG9yYWdlRmlsZSwgSlNPTi5zdHJpbmdpZnkodGhpcy5zdG9yYWdlKSwgJ3V0ZjgnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkcyB0aGUgc3RvcmFnZSBqc29uIGZpbGUuIElmIHRoZXJlIHdlcmUgYW55IGtleXMgYWxyZWFkeSBzZXQgaXQgbWVyZ2VzIHRoZW1cbiAgICAgKiB3aXRoIHdoYXQgaGFzIGJlZW4gbG9hZGVkLlxuICAgICAqL1xuICAgIGluaXQoKSB7XG4gICAgICAgIGxldCBzdG9yYWdlID0ge307XG4gICAgICAgIGZzLnJlYWRGaWxlKHRoaXMuc3RvcmFnZUZpbGUsICd1dGY4JywgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHRoaXMuZmx1c2goKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYGxvYWRlZCBzdG9yYWdlIGZpbGUgJHt0aGlzLnN0b3JhZ2VGaWxlfWApO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cud2FybihgY291bGQgbm90IHBhcnNlIHRoZSBzdG9yYWdlIGZpbGUgJHt0aGlzLnN0b3JhZ2VGaWxlfWApO1xuICAgICAgICAgICAgICAgICAgICAvLyBOb3RoaW5nIHRvIGRvIGhlcmUuIFdlIHdpbGwgcHV0IGEgZnJlc2ggZmlsZSBpbiBwbGFjZSBmZXcgbGluZXMgYmVsb3cuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLnN0b3JhZ2UpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlID0gT2JqZWN0LmFzc2lnbihzdG9yYWdlLCB0aGlzLnN0b3JhZ2UpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuZmx1c2goKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuaW5pdERvbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5sb2cuaW5mbyhgaGF2ZSAke09iamVjdC5rZXlzKHRoaXMuc3RvcmFnZSkubGVuZ3RofSBrZXlzYCk7XG4gICAgICAgICAgICB0aGlzLmV2ZW50c0J1cy5lbWl0KCdsb2NhbFN0b3JhZ2UubG9hZGVkJyk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==